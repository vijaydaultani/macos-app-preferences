#!/usr/bin/env python3

# <xbar.title>Process Status</xbar.title>
# <xbar.version>v1.1</xbar.version>
# <xbar.author>Federico Ferri</xbar.author>
# <xbar.author.github>fferri</xbar.author.github>
# <xbar.desc>Simple Process Status.</xbar.desc>
# <xbar.dependencies>python</xbar.dependencies>
# <xbar.image>https://raw.githubusercontent.com/fferri/bitbar-countdown-timer/master/screenshot.gif</xbar.image>
# <xbar.abouturl>https://github.com/fferri/bitbar-countdown-timer</xbar.abouturl>

import os
import re
import subprocess
import sys
import time
import paramiko

icon='iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAADhAJiYAAAAAXNSR0IArs4c6QAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDUuNC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KTMInWQAAAxZJREFUWAntlluITVEYx8+4jbuQ++CFSC655Tau8aA8eFKaJzKvlHfFwzwg1+TVRJNQU5SSUAZNIyNyy4gQcikkJLn9/lnLrHXss9bee868zVe/sy7f9//WOmvvvdYqFLosvAIVYXfQW4n3JPRLiNpGX3NCf6d29Sf77xKszztyt7zCiK6z8kaGLRTWEvEY3JXaTXtoVJkzYD66IQGt3qM74E6oJhDfIddkM1ArpTupWbTr4IXxu5Ox9a/46mEZlMWqyPIT7ADDqWs16p0++b7DXTgNjXAV3oPVqWyBBZDbqlG6CTWxBnji9B+lvhAGQbH1pGMCbIa3YHPtpJ7LZqJqA5vILa/QvyhD1t7E7nJy7cmg9UL1eFbDWbATOuhFZGusJFyPV7nqskn9aL0fSnLI787Vsh+J8ulxZ7bzKCR+kFnpC3o5zVrqyvnR6UtVHWeEEk9Lpfg/SF/q8wS93kPl1SuR2vYRKdGR1Ao/cKTR64DVV+ea/Yq1oaYy3QA+gya0JpXCD+pjtLoJlLI3OJR/SqkAt3+eCf5BOdh1BOrd8ekaMhZ+QQOETJ+/JqS9yrOkU3muibhN+cGLTm4sN3GvKe/BMYidZ03EyPQHPEua0GgToZ05ZtJfghOgk78vHICYvTQBA4sDkyZkX0I9sphZvVblogleERPh13Eks2P9bfHb41+tvfLJVIe1d5WsadLb4QK8gsuwH2Jmbw+6FXiWNKFHJmKGF1m6sQNXC0yCNI9LmabqB9PNIGpjiNAXIGZHo/MFXDP5U9+9bxnB1nzjBVVVJrf+8IBgpONcZ0TPnL5yVfea3IezJrSPrSPXjuIxx5vJKPeoYmesXeuIs1zKQnm1t2kyx0NBId85k0DHwZJQYMSnr1kbqCbzFHKbDsqHoERiI2S16QhugPTfQO0OWSXq+2An1UR9aYqM2j7sISqtbhC6NQatIuj1ndqBtzhd2kCvQyu0gXZtnYNagWqYA9bOUNkE72xHucpVJGoEu1qxUkfJhiyDZ1khN+9EGtplF8MI0AanXF9Aq3ATTkEzdFlZV+APQ77IUZhTv+IAAAAASUVORK5CYII='

def prompt(text='', defaultAnswer='', icon='note', buttons=('Cancel','Ok'), defaultButton=1):
    try:
        d = locals()
        d['buttonsStr'] = ', '.join('"%s"' % button for button in buttons)
        d['defaultButtonStr'] = isinstance(defaultButton, int) and buttons[defaultButton] or defaultButton
        return subprocess.check_output(['osascript', '-l', 'JavaScript', '-e', '''
            const app = Application.currentApplication()
            app.includeStandardAdditions = true
            const response = app.displayDialog("{text}", {{
                defaultAnswer: "{defaultAnswer}",
                withIcon: "{icon}",
                buttons: [{buttonsStr}],
                defaultButton: "{defaultButtonStr}"
            }})
            response.textReturned
        '''.format(**d)]).rstrip().decode("utf-8")
    except subprocess.CalledProcessError:
        pass

def notify(text, title, sound='Glass'):
    os.system('osascript -e \'display notification "{}" with title "{}" sound name "{}"\''.format(text, title, sound))

def entry(title='---', **kwargs):
    args = ' '.join('{}=\'{}\''.format(k,v) for k,v in list(kwargs.items()) if v is not None)
    if args: args = '|' + args
    print((title + args))

def parse_time(s):
    m = re.match('^((\d+)h)?((\d+)m)?((\d+)s?)?$', s)
    if m is None: raise Exception('invalid time: %s' % s)
    h, m, s = list(map(int, (m.group(i) or 0 for i in (2, 4, 6))))
    return s + 60 * (m + 60 * h)

def render_time(t):
    t = int(round(t))
    h = t // 3600
    t -= h * 3600
    m = t // 60
    t -= m * 60
    k, v = 'hms', (h, m, t)
    return ''.join('%d%s' % (v[i], k[i]) for i in range(3) if i == 2 or any(v[:i+1]))

def read_data_file(filename):
    with open(data_file, 'rt') as f:
        lines = f.readlines()
    process_id = int(lines[0])
    process_status = int(lines[1])
    return process_id, process_status

def write_data_file(filename, process_id, process_status):
    with open(data_file, 'wt') as f:
        #f.write('{:f}{}{}'.format(process_id, '\n' , process_status))
        f.write("{}{}{}".format(process_id, '\n' , process_status))

def check_process_status(PID):
    # Define login server and application server
    LOGIN_SERVER="192.168.1.102"
    APPLICATION_SERVER = "daultani@hestia"

    # Define PID of the process you want to check
    #PID = "1598179"

    # SSH into the login server
    login_ssh = paramiko.SSHClient()
    login_ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    login_ssh.connect(LOGIN_SERVER,username="daultani")

    # SSH into the application server from the login server
    stdin, stdout, stderr = login_ssh.exec_command(f'ssh {APPLICATION_SERVER} "ps -p {PID} | grep {PID}"')
    stdin.close()
    output = stdout.read().decode().strip()
    # Close SSH connections
    login_ssh.close()

    # Check the exit status of the last command
    if output:
        #print(f"{PID}: Running")
        return 1
    else:
        #print(f"{PID}: Stopped")
        return 0
    return 0


def usage():
    print(('''usage: {0} <time> [task_name]
time can be:
    N or Ns: number of seconds
    Nm: number of minutes
    Nh: number of hours

example:
    {0} 5m30s 'Egg is ready!'
'''.format(__file__)))
    sys.exit(1)

data_file = os.path.join(os.path.dirname(os.path.realpath(__file__)), '.' + os.path.basename(__file__) + '.process_id')

if len(sys.argv) == 1:
    if os.path.isfile(data_file):
        # Get the process_id that you want to track
        process_id, _ = read_data_file(data_file)
        # Check the latest status without prompting user for the process_id
        process_status = check_process_status(process_id)
        # Write to the file to read back
        write_data_file(data_file, process_id, process_status)
        # Read back from the file
        process_id, process_status = read_data_file(data_file)
        if process_status == 0:
            entry("Stopped", color=('red'))
        else:
            entry("Running", color=('green'))
    else:
        entry('|templateImage=\'%s\'' % icon)
    entry('---')
    if os.path.isfile(data_file):
        entry('Cancel Tracking', bash=__file__, param1='cancel', terminal='false')
    else:
        entry('Set Tracking', bash=__file__, param1='set', terminal='false')            
elif len(sys.argv) == 2 and sys.argv[1] == 'set':
    process_id = prompt('Input Process ID')
    process_status = check_process_status(process_id)
    #print("dumping process_id: {} process_status: {} file: {}".format(process_id, process_status, data_file))
    write_data_file(data_file, process_id, process_status)
elif len(sys.argv) == 2 and sys.argv[1] == 'cancel':
    os.remove(data_file)    
