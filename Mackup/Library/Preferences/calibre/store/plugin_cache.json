{
  "ebookshoppe_uk": "# -*-\nfrom __future__ import absolute_import, division, print_function, unicode_literals\n\nstore_version = 1  # Needed for dynamic plugin loading\n\n__license__ = 'GPL 3'\n__copyright__ = '2011, John Schember <john@nachtimwald.com>'\n__docformat__ = 'restructuredtext en'\n\ntry:\n    from urllib.parse import quote\nexcept ImportError:\n    from urllib2 import quote\nfrom contextlib import closing\n\nfrom lxml import html\n\nfrom qt.core import QUrl\n\nfrom calibre import browser\nfrom calibre.gui2 import open_url\nfrom calibre.gui2.store import StorePlugin\nfrom calibre.gui2.store.basic_config import BasicStoreConfig\nfrom calibre.gui2.store.search_result import SearchResult\nfrom calibre.gui2.store.web_store_dialog import WebStoreDialog\n\n\nclass EBookShoppeUKStore(BasicStoreConfig, StorePlugin):\n\n    def open(self, parent=None, detail_item=None, external=False):\n        url_details = 'http://www.awin1.com/cread.php?awinmid=1414&awinaffid=120917&clickref=&p={0}'\n        url = 'http://www.awin1.com/awclick.php?mid=2666&id=120917'\n\n        if external or self.config.get('open_external', False):\n            if detail_item:\n                url = url_details.format(detail_item)\n            open_url(QUrl(url))\n        else:\n            detail_url = None\n            if detail_item:\n                detail_url = url_details.format(detail_item)\n            d = WebStoreDialog(self.gui, url, parent, detail_url)\n            d.setWindowTitle(self.name)\n            d.set_tags(self.config.get('tags', ''))\n            d.exec()\n\n    def search(self, query, max_results=10, timeout=60):\n        url = 'http://www.ebookshoppe.com/search.php?search_query=' + quote(query)\n        br = browser()\n        br.addheaders = [(\"Referer\", \"http://www.ebookshoppe.com/\")]\n\n        counter = max_results\n        with closing(br.open(url, timeout=timeout)) as f:\n            doc = html.fromstring(f.read())\n            for data in doc.xpath('//ul[@class=\"ProductList\"]/li'):\n                if counter <= 0:\n                    break\n\n                id = ''.join(data.xpath('./div[@class=\"ProductDetails\"]/'\n                                        'strong/a/@href')).strip()\n                if not id:\n                    continue\n                cover_url = ''.join(data.xpath('./div[@class=\"ProductImage\"]/a/img/@src'))\n                title = ''.join(data.xpath('./div[@class=\"ProductDetails\"]/strong/a/text()'))\n                price = ''.join(data.xpath('./div[@class=\"ProductPriceRating\"]/em/text()'))\n                counter -= 1\n\n                s = SearchResult()\n                s.cover_url = cover_url\n                s.title = title.strip()\n                s.price = price\n                s.drm = SearchResult.DRM_UNLOCKED\n                s.detail_item = id\n\n                self.get_author_and_formats(s, timeout)\n                if not s.author:\n                    continue\n\n                yield s\n\n    def get_author_and_formats(self, search_result, timeout):\n        br = browser()\n        with closing(br.open(search_result.detail_item, timeout=timeout)) as nf:\n            idata = html.fromstring(nf.read())\n            author = ''.join(idata.xpath('//div[@id=\"ProductOtherDetails\"]/dl/dd[1]/text()'))\n            if author:\n                search_result.author = author\n            formats = idata.xpath('//dl[@class=\"ProductAddToCart\"]/dd/'\n                                  'ul[@class=\"ProductOptionList\"]/li/label/text()')\n            if formats:\n                search_result.formats = ', '.join(formats)\n            search_result.drm = SearchResult.DRM_UNKNOWN\n        return True\n",
  "kobo": "# -*-\nfrom __future__ import absolute_import, division, print_function, unicode_literals\n\nstore_version = 11  # Needed for dynamic plugin loading\n\n__license__ = 'GPL 3'\n__copyright__ = '2011, John Schember <john@nachtimwald.com>'\n__docformat__ = 'restructuredtext en'\n\ntry:\n    from urllib.parse import quote_plus\nexcept ImportError:\n    from urllib import quote_plus\n\nfrom lxml import etree, html\n\nfrom calibre import url_slash_cleaner\nfrom calibre.ebooks.metadata import authors_to_string\nfrom calibre.gui2 import open_url\nfrom calibre.gui2.store import StorePlugin\nfrom calibre.gui2.store.basic_config import BasicStoreConfig\nfrom calibre.gui2.store.search_result import SearchResult\nfrom calibre.gui2.store.web_store_dialog import WebStoreDialog\n\n\ndef read_url(url, timeout=60):\n    # Kobo uses Akamai which has some bot detection that uses network/tls\n    # protocol data. So use the Chromium network stack to make the request\n    from calibre.scraper.simple import read_url as ru\n    return ru(read_url.storage, url, timeout=timeout)\n\n\nread_url.storage = []\n\n\ndef search_kobo(query, max_results=10, timeout=60, write_html_to=None):\n    from css_selectors import Select\n    url = 'https://www.kobobooks.com/search/search.html?q=' + quote_plus(query)\n    raw = read_url(url, timeout=timeout)\n    if write_html_to is not None:\n        with open(write_html_to, 'w') as f:\n            f.write(raw)\n    doc = html.fromstring(raw)\n    select = Select(doc)\n    for i, item in enumerate(select('.result-items .item-wrapper.book')):\n        if i == max_results:\n            break\n        for img in select('.item-image img[src]', item):\n            cover_url = img.get('src')\n            if cover_url.startswith('//'):\n                cover_url = 'https:' + cover_url\n            break\n        else:\n            cover_url = None\n\n        for p in select('h2.title', item):\n            title = etree.tostring(p, method='text', encoding='unicode').strip()\n            for a in select('a[href]', p):\n                url = a.get('href')\n                break\n            else:\n                url = None\n            break\n        else:\n            title = None\n        if title:\n            for p in select('p.subtitle', item):\n                title += ' - ' + etree.tostring(p, method='text', encoding='unicode').strip()\n\n        authors = []\n        for a in select('.contributors a.contributor-name', item):\n            authors.append(etree.tostring(a, method='text', encoding='unicode').strip())\n        authors = authors_to_string(authors)\n\n        for p in select('p.price', item):\n            price = etree.tostring(p, method='text', encoding='unicode').strip()\n            break\n        else:\n            price = None\n\n        if title and authors and url:\n            s = SearchResult()\n            s.cover_url = cover_url\n            s.title = title\n            s.author = authors\n            s.price = price\n            s.detail_item = url\n            s.formats = 'EPUB'\n            s.drm = SearchResult.DRM_UNKNOWN\n\n            yield s\n\n\nclass KoboStore(BasicStoreConfig, StorePlugin):\n\n    minimum_calibre_version = (5, 40, 1)\n\n    def open(self, parent=None, detail_item=None, external=False):\n        if detail_item:\n            purl = detail_item\n            url = purl\n        else:\n            purl = None\n            url = 'https://kobo.com'\n\n        if external or self.config.get('open_external', False):\n            open_url(url_slash_cleaner(url))\n        else:\n            d = WebStoreDialog(self.gui, url, parent, purl)\n            d.setWindowTitle(self.name)\n            d.set_tags(self.config.get('tags', ''))\n            d.exec()\n\n    def search(self, query, max_results=10, timeout=60):\n        for result in search_kobo(query, max_results=max_results, timeout=timeout):\n            yield result\n\n    def get_details(self, search_result, timeout):\n        raw = read_url(search_result.detail_item, timeout=timeout)\n        idata = html.fromstring(raw)\n        if idata.xpath('boolean(//div[@class=\"bookitem-secondary-metadata\"]//li[contains(text(), \"Download options\")])'):\n            if idata.xpath('boolean(//div[@class=\"bookitem-secondary-metadata\"]//li[contains(text(), \"DRM-Free\")])'):\n                search_result.drm = SearchResult.DRM_UNLOCKED\n            if idata.xpath('boolean(//div[@class=\"bookitem-secondary-metadata\"]//li[contains(text(), \"Adobe DRM\")])'):\n                search_result.drm = SearchResult.DRM_LOCKED\n        else:\n            search_result.drm = SearchResult.DRM_UNKNOWN\n        return True\n\n\nif __name__ == '__main__':\n    import sys\n\n    for result in search_kobo(' '.join(sys.argv[1:]), write_html_to='/t/kobo.html'):\n        print(result)\n",
  "ozon_ru": "# -*-\nfrom __future__ import absolute_import, division, print_function, unicode_literals\n\nstore_version = 3  # Needed for dynamic plugin loading\n\n__license__ = 'GPL 3'\n__copyright__ = '2011-2013, Roman Mukhin <ramses_ru at hotmail.com>'\n__docformat__ = 'restructuredtext en'\n\nfrom contextlib import closing\ntry:\n    from urllib.parse import quote_plus\nexcept ImportError:\n    from urllib import quote_plus\n\nfrom qt.core import QUrl\n\nfrom calibre import browser, url_slash_cleaner\nfrom calibre.ebooks.chardet import xml_to_unicode\nfrom calibre.gui2 import open_url\nfrom calibre.gui2.store import StorePlugin\nfrom calibre.gui2.store.search_result import SearchResult\nfrom calibre.gui2.store.web_store_dialog import WebStoreDialog\n\nshop_url = 'http://www.ozon.ru'\n\n\ndef parse_html(raw):\n    try:\n        from html5_parser import parse\n    except ImportError:\n        # Old versions of calibre\n        import html5lib\n        return html5lib.parse(raw, treebuilder='lxml', namespaceHTMLElements=False)\n    else:\n        return parse(raw)\n\n\ndef search(query, max_results=15, timeout=60):\n    url = 'http://www.ozon.ru/?context=search&text=%s&store=1,0&group=div_book' % quote_plus(query)\n\n    counter = max_results\n    br = browser()\n\n    with closing(br.open(url, timeout=timeout)) as f:\n        raw = xml_to_unicode(f.read(), strip_encoding_pats=True, assume_utf8=True)[0]\n        root = parse_html(raw)\n        for tile in root.xpath('//*[@class=\"bShelfTile inline\"]'):\n            if counter <= 0:\n                break\n            counter -= 1\n\n            s = SearchResult(store_name='OZON.ru')\n            s.detail_item = shop_url + tile.xpath('descendant::a[@class=\"eShelfTile_Link\"]/@href')[0]\n            s.title = tile.xpath('descendant::span[@class=\"eShelfTile_ItemNameText\"]/@title')[0]\n            s.author = tile.xpath('descendant::span[@class=\"eShelfTile_ItemPerson\"]/@title')[0]\n            s.price = ''.join(tile.xpath('descendant::div[contains(@class, \"eShelfTile_Price\")]/text()'))\n            s.cover_url = 'http:' + tile.xpath('descendant::img/@data-original')[0]\n            s.price = format_price_in_RUR(s.price)\n            yield s\n\n\nclass OzonRUStore(StorePlugin):\n\n    def open(self, parent=None, detail_item=None, external=False):\n        url = detail_item or shop_url\n        if external or self.config.get('open_external', False):\n            open_url(QUrl(url_slash_cleaner(url)))\n        else:\n            d = WebStoreDialog(self.gui, shop_url, parent, url)\n            d.setWindowTitle(self.name)\n            d.set_tags(self.config.get('tags', ''))\n            d.exec()\n\n    def search(self, query, max_results=15, timeout=60):\n        for s in search(query, max_results=max_results, timeout=timeout):\n            yield s\n\n\ndef format_price_in_RUR(price):\n    '''\n    Try to format price according ru locale: '12 212,34 руб.'\n    @param price: price in format like 25.99\n    @return: formatted price if possible otherwise original value\n    @rtype: unicode\n    '''\n    price = price.replace('\\xa0', '').replace(',', '.').strip() + ' py6'\n    return price\n\n\nif __name__ == '__main__':\n    import sys\n    for r in search(sys.argv[-1]):\n        print(r)\n"
}